<!DOCTYPE html>

<html lang="ru"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Экран Сравнения ВУЗов - UniGuide</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#137fec",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
    }
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-gray-200 dark:border-b-gray-800 px-4 sm:px-10 py-3 bg-white dark:bg-background-dark">
<div class="flex items-center gap-8">
<div class="flex items-center gap-4 text-gray-900 dark:text-white">
<div class="size-6 text-primary">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
</svg>
</div>
<h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">UniGuide</h2>
</div>
<label class="hidden md:flex flex-col min-w-40 !h-10 max-w-64">
<div class="flex w-full flex-1 items-stretch rounded-lg h-full">
<div class="text-gray-500 dark:text-gray-400 flex bg-gray-100 dark:bg-gray-800 items-center justify-center pl-3 rounded-l-lg border-r-0">
<span class="material-symbols-outlined text-xl">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-0 border-none bg-gray-100 dark:bg-gray-800 focus:border-none h-full placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 rounded-l-none border-l-0 pl-2 text-sm font-normal leading-normal" placeholder="Search" value=""/>
</div>
</label>
</div>
<div class="flex flex-1 justify-end items-center gap-4 sm:gap-8">
<div class="hidden lg:flex items-center gap-6">
<a class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal" href="#">Universities</a>
<a class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal" href="#">Programs</a>
<a class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal" href="#">Grants</a>
<a class="text-primary dark:text-primary text-sm font-bold leading-normal" href="#">Compare</a>
</div>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Sign In</span>
</button>
<div class="hidden sm:block bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User avatar" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC8BLQzqpZy6Uh9sDzb6ytJ5_-GydoTBA9cgpsFKD4b40K2J56igRt2QqTSuASG-gX2c0xuVrt3jHlXXNOL9erpjjRt_6bJDM4PVvP9qV_fGt88hBUGFrdNJu4amfYBmXyIXC3FNkaa0P4GYpUj7l6GCOaWrZwtPztgwU1EVi7W7Dwcuh2ZZtTLstzqfZlC97uCHxQiOo7R4kgzXBpV8qEUIA8JIH3Nha6wykYOLHYbFVEMAKIWRf647NDNarxRm70dmW0lqlm0J-o");'></div>
</div>
</header>
<main class="flex-1 px-4 sm:px-8 md:px-10 lg:px-20 xl:px-40 py-8">
<div class="layout-content-container flex flex-col max-w-7xl mx-auto flex-1 gap-8">
<div class="flex flex-wrap justify-between items-start gap-4 p-4">
<div class="flex min-w-72 flex-col gap-2">
<p class="text-gray-900 dark:text-white text-3xl sm:text-4xl font-black leading-tight tracking-[-0.033em]">Сравнение ВУЗов</p>
<p class="text-gray-600 dark:text-gray-400 text-base font-normal leading-normal">Сравните до 3 учебных заведений бок о бок, чтобы сделать правильный выбор.</p>
</div>
</div>
<div class="px-4 py-3 @container">
<div class="overflow-x-auto rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark shadow-sm">
<table class="w-full text-left" id="comparison-table">
<thead id="table-head">
</thead>
<tbody id="table-body">
</tbody>
</table>
</div>
</div>
<div class="p-4" id="no-comparison-message" style="display: none;">
<div class="flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 px-6 py-14">
<div class="flex max-w-lg flex-col items-center gap-2 text-center">
<p class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Нет выбранных ВУЗов для сравнения?</p>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal">
                                        Начните с добавления университетов в список сравнения, чтобы увидеть их ключевые различия и сделать осознанный выбор.
                                    </p>
</div>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Добавить ВУЗ для сравнения</span>
</button>
</div>
</div>
</div>
</main>
</div>
</div>
<script>
    // URL твоего работающего бэкенда
    const API_BASE_URL = 'http://127.0.0.1:8000/api';

    // Список ID вузов для сравнения. 
    // В реальном приложении этот список нужно получать из URL-параметров или LocalStorage.
    // Используем ID 1, 2, 4 (KBTU, SDU, Satbayev) для примера.
    const DEFAULT_UNI_IDS = [1, 2, 4]; 
    
    // Вспомогательная функция для форматирования денег (например, 1000000 -> 1 000 000 ₸)
    function formatCurrency(amount) {
        if (amount === 0 || amount === null || isNaN(amount)) return 'Бесплатно';
        if (typeof amount === 'number') {
             return new Intl.NumberFormat('ru-RU', { 
                style: 'currency', 
                currency: 'KZT', 
                minimumFractionDigits: 0 
            }).format(amount).replace('KZT', '₸');
        }
        return amount;
    }

    // Главная функция для загрузки и отрисовки данных
    async function loadComparisonData() {
        const table = document.getElementById('comparison-table');
        const head = document.getElementById('table-head');
        const body = document.getElementById('table-body');
        const noDataMessage = document.getElementById('no-comparison-message');
        
        head.innerHTML = '';
        body.innerHTML = '';
        table.style.display = 'table';
        noDataMessage.style.display = 'none';

        if (DEFAULT_UNI_IDS.length < 2) {
             table.style.display = 'none';
             noDataMessage.style.display = 'block';
             return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/compare`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'accept': 'application/json'
                },
                body: JSON.stringify({ university_ids: DEFAULT_UNI_IDS })
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({ detail: `Unknown error. Status: ${response.status}` }));
                throw new Error(`Ошибка API: ${errorBody.detail}`);
            }

            const data = await response.json();
            const comparisonData = data.comparison;
            
            if (comparisonData.universities.length < 2) {
                table.style.display = 'none';
                noDataMessage.style.display = 'block';
                return; 
            }

            renderTableHeader(head, comparisonData.universities);
            renderTableBody(body, comparisonData.metrics, comparisonData.universities.length);

        } catch (error) {
            console.error("Ошибка при загрузке данных сравнения:", error);
            body.innerHTML = `<tr><td colspan="${DEFAULT_UNI_IDS.length + 1}" class="px-4 py-4 text-red-500 text-center">Ошибка загрузки данных: ${error.message}. Проверьте сервер и консоль.</td></tr>`;
        }
    }

    // ----------------------
    // Отрисовка шапки таблицы (Названия ВУЗов)
    // ----------------------
    function renderTableHeader(headElement, universities) {
        // *ИСПРАВЛЕНИЕ: Удалено создание вложенного thead.*
        const row = document.createElement('tr');
        row.className = 'bg-white dark:bg-background-dark';
        
        // 1. Столбец "Параметр"
        row.innerHTML += `
            <th class="px-4 py-5 text-gray-800 dark:text-gray-200 min-w-[200px] w-1/4 text-sm font-medium leading-normal sticky left-0 z-10 bg-white dark:bg-background-dark">
                Параметр
            </th>
        `;

        // 2. Столбцы для каждого ВУЗа
        universities.forEach(uni => {
            row.innerHTML += `
                <th class="px-4 py-5 min-w-[240px] w-1/4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-900 dark:text-white text-sm font-medium leading-normal">${uni.name}</span>
                        <button class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-500">
                            <span class="material-symbols-outlined text-xl">close</span>
                        </button>
                    </div>
                </th>
            `;
        });
        
        // 3. Столбец "Добавить ВУЗ"
        row.innerHTML += `
            <th class="px-4 py-5 min-w-[240px] w-1/4">
                <button class="flex w-full items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700 p-3 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <span class="material-symbols-outlined">add</span>
                    <span class="text-sm font-bold">Добавить ВУЗ</span>
                </button>
            </th>
        `;
        
        headElement.appendChild(row); // *ИСПРАВЛЕНИЕ: Аппендируем tr прямо в thead*
    }

    // ----------------------
    // Отрисовка тела таблицы (Метрики)
    // ----------------------
    function renderTableBody(bodyElement, metrics, numUnis) {
        metrics.forEach((metric, index) => {
            const row = document.createElement('tr');
            row.className = 'border-t border-t-gray-200 dark:border-t-gray-800';

            // 1. Ячейка с названием параметра (Sticky)
            row.innerHTML += `
                <td class="px-4 py-4 min-h-[72px] text-gray-800 dark:text-gray-200 text-sm font-normal leading-normal sticky left-0 z-10 bg-white dark:bg-background-dark">
                    ${metric.label}
                </td>
            `;

            // 2. Ячейки со значениями для каждого ВУЗа
            metric.values.forEach(value => {
                let displayValue = value;
                
                if (metric.key.includes('cost') || metric.key.includes('avg_cost')) {
                    displayValue = formatCurrency(value);
                } else if (metric.key === 'dormitory') {
                    displayValue = value;
                }
                
                // Логика подсветки
                let tag = '';
                const allValues = metrics.find(m => m.key === metric.key).values;
                const numericValues = allValues.filter(v => typeof v === 'number' && v !== null);

                if (metric.key === 'avg_cost') {
                    if (value === Math.min(...numericValues.filter(c => c > 0))) {
                        tag = '<span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900 px-2 py-0.5 text-xs font-medium text-green-700 dark:text-green-300">Выгоднее</span>';
                    }
                } else if (metric.key === 'programs_count') {
                    if (value === Math.max(...numericValues)) {
                        tag = '<span class="inline-flex items-center rounded-full bg-blue-100 dark:bg-blue-900 px-2 py-0.5 text-xs font-medium text-blue-700 dark:text-blue-300">Больше выбор</span>';
                    }
                } else if (metric.key === 'min_ent_score') {
                    if (value === Math.min(...numericValues)) {
                         tag = '<span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900 px-2 py-0.5 text-xs font-medium text-green-700 dark:text-green-300">Проще поступить</span>';
                    }
                }
                
                row.innerHTML += `
                    <td class="px-4 py-4 min-h-[72px] text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal">
                        <div class="flex items-center gap-2">
                            <span>${displayValue}</span>
                            ${tag}
                        </div>
                    </td>
                `;
            });

            // 3. Пустая ячейка для последней колонки ("Добавить ВУЗ")
            row.innerHTML += `<td class="px-4 py-4 min-h-[72px]"></td>`;
            bodyElement.appendChild(row);
        });
        
        // Добавляем строку с кнопками "Подробнее/Подать заявку"
        addFooterButtons(bodyElement, numUnis);
    }
    
    function addFooterButtons(bodyElement, numUnis) {
        const row = document.createElement('tr');
        row.className = 'border-t border-t-gray-200 dark:border-t-gray-800';
        
        // Пустая ячейка для колонки "Параметр"
        row.innerHTML += '<td class="px-4 py-6 sticky left-0 z-10 bg-white dark:bg-background-dark"></td>';
        
        for (let i = 0; i < numUnis; i++) {
            const uniId = DEFAULT_UNI_IDS[i]; 
            
            row.innerHTML += `
                <td class="px-4 py-6">
                    <div class="flex flex-col sm:flex-row flex-1 gap-3 flex-wrap justify-start">
                        <button class="flex min-w-[84px] max-w-[480px] flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">Подать заявку</span>
                        </button>
                        <a href="vuz.html?id=${uniId}" class="flex min-w-[84px] max-w-[480px] flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-base font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">Подробнее</span>
                        </a>
                    </div>
                </td>
            `;
        }
        
        // Пустая ячейка для последней колонки
        row.innerHTML += `<td class="px-4 py-6"></td>`;
        bodyElement.appendChild(row);
    }
    
    loadComparisonData();
</script>
</body></html>